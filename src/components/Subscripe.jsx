import axios from "axios";
import { jwtDecode } from "jwt-decode";
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { ToastContainer, toast } from "react-toastify";

const Subscripe = () => {
  const [user, setUser] = useState(null); // Menggunakan null sebagai nilai awal
  const [error, setError] = useState(null);
  const [email, setEmail] = useState(""); // State untuk menangani error
  const navigate = useNavigate(); // Inisialisasi navigate

  useEffect(() => {
    const token = sessionStorage.getItem("token"); // Mengambil token dari ss

    if (token) {
      try {
        const decoded = jwtDecode(token); // Mendekode token
        setUser(decoded); // Menyimpan hasil dekode ke state user
      } catch (error) {
        console.error("Error decoding token", error);
      }
    }
  }, [navigate]);

  const handleChange = (e) => {
    setEmail(e.target.value);
  };

  const handleSubscribe = async (e) => {
    try {
      const response = await axios.post(
        `${process.env.REACT_APP_API_URL}/subscriptions/${user.user_id}`,
        {
          description: email,
          price: 150000,
          status: "Active",
        }
      );

      if (response.data.token && response.data.subscription?.subscription_id) {
        const { subscription } = response.data;

        sessionStorage.setItem("token", response.data.token);
        navigate("/payment", {
          state: {
            payable_type: "App\\Models\\Subscriptions",
            payable_id: subscription.subscription_id,
            amount: 150000,
          },
        });
      } else {
        console.error("Response data does not have subscription_id.");
      }
    } catch (error) {
      toast.error("Please check your email", {
        position: "top-center",
        autoClose: 3000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
        progress: undefined,
      });

      console.error(error);
    }
  };

  return (
    <div>
      {user && user.subscription_status !== "Aktif" ? (
      <div id="subscripe">
          <div className="container">
            <div>
              <h2>Subscribe</h2>
              <p>Klik subscribe dan jangan ketinggalan penawaran baru kami!</p>
              <div>
                <span>
                  <svg
                    width="44"
                    height="44"
                    viewBox="0 0 44 44"
                    fill="none"
                    className="email"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <g clip-path="url(#clip0_623_80)">
                      <path
                        d="M4.62682 6.49854C4.78292 6.49824 4.93902 6.49783 5.09511 6.49732C5.52264 6.49625 5.95015 6.49678 6.37768 6.49758C6.8393 6.49816 7.30092 6.49726 7.76254 6.49655C8.66629 6.4954 9.57004 6.49565 10.4738 6.4964C11.2083 6.49698 11.9429 6.49706 12.6775 6.49678C12.782 6.49674 12.8866 6.4967 12.9944 6.49666C13.2068 6.49658 13.4193 6.49649 13.6317 6.49641C15.6235 6.49567 17.6153 6.49652 19.6071 6.4979C21.3159 6.49906 23.0246 6.49886 24.7334 6.49767C26.7181 6.49629 28.7028 6.49574 30.6875 6.49654C30.8992 6.49662 31.1109 6.4967 31.3225 6.49678C31.4267 6.49682 31.5308 6.49686 31.6381 6.4969C32.3717 6.49712 33.1053 6.49675 33.8389 6.49614C34.7331 6.49542 35.6272 6.49561 36.5213 6.49699C36.9774 6.49766 37.4335 6.49793 37.8896 6.49708C38.3073 6.49631 38.725 6.49673 39.1427 6.4981C39.2937 6.49839 39.4446 6.49824 39.5955 6.49762C40.3503 6.49473 41.055 6.49631 41.7656 6.78909C41.6382 7.05607 41.5101 7.23604 41.2973 7.44302C41.2092 7.52976 41.2092 7.52976 41.1192 7.61825C41.0271 7.70765 41.0271 7.70765 40.9331 7.79886C40.8126 7.91635 40.6923 8.03407 40.5722 8.15201C40.4922 8.22973 40.4922 8.22973 40.4105 8.30903C40.2503 8.47511 40.1003 8.64421 39.9501 8.81916C39.6185 9.19888 39.2685 9.55677 38.9121 9.91305C38.8435 9.98195 38.775 10.0508 38.7043 10.1218C38.476 10.3511 38.2474 10.58 38.0188 10.809C37.8544 10.9739 37.69 11.1388 37.5257 11.3037C37.0341 11.797 36.5421 12.2899 36.0501 12.7827C35.8181 13.015 35.5861 13.2475 35.3542 13.4799C34.5828 14.2527 33.8114 15.0254 33.0397 15.7977C32.8399 15.9977 32.6402 16.1976 32.4404 16.3975C32.366 16.472 32.366 16.472 32.29 16.548C31.4843 17.3545 30.6793 18.1616 29.8746 18.9691C29.0477 19.7989 28.2201 20.628 27.3918 21.4565C26.9271 21.9214 26.4627 22.3866 25.999 22.8525C25.6045 23.2488 25.2095 23.6446 24.8137 24.0395C24.6118 24.241 24.4103 24.4429 24.2094 24.6453C23.9916 24.8646 23.7727 25.0829 23.5535 25.3009C23.4902 25.3652 23.4269 25.4294 23.3617 25.4956C22.8866 25.9648 22.5286 26.1374 21.8473 26.1562C21.1762 26.0466 20.7908 25.652 20.3306 25.1851C20.26 25.1148 20.1894 25.0445 20.1166 24.9721C19.9216 24.7777 19.7273 24.5825 19.5333 24.387C19.3237 24.176 19.113 23.966 18.9024 23.7559C18.4904 23.3444 18.0792 22.9319 17.6684 22.5192C17.1895 22.0382 16.7097 21.5582 16.2298 21.0782C15.3733 20.2213 14.5176 19.3636 13.6623 18.5055C12.8333 17.6737 12.0037 16.8423 11.1736 16.0115C11.1225 15.9603 11.0714 15.9092 11.0188 15.8565C10.8133 15.6509 10.6079 15.4454 10.4025 15.2398C9.61043 14.4471 8.81871 13.654 8.02706 12.8609C7.78821 12.6216 7.54934 12.3823 7.31044 12.143C6.80809 11.6399 6.30587 11.1366 5.80403 10.633C5.59659 10.4248 5.38909 10.2167 5.1814 10.0088C4.95584 9.78289 4.73054 9.55672 4.50531 9.33048C4.40774 9.23294 4.40774 9.23294 4.3082 9.13342C3.96232 8.78537 3.63068 8.42991 3.31176 8.05693C3.0705 7.78173 2.80535 7.53145 2.54103 7.27853C2.43574 7.17573 2.33464 7.06867 2.23438 6.96097C2.23438 6.90425 2.23438 6.84753 2.23438 6.78909C3.01366 6.46802 3.8006 6.49511 4.62682 6.49854Z"
                        fill="white"
                      />
                      <path
                        d="M15.3828 23.8047C15.671 23.9412 15.8581 24.0887 16.0819 24.3179C16.1511 24.3882 16.2203 24.4585 16.2916 24.5309C16.4029 24.6452 16.4029 24.6452 16.5164 24.7617C16.6347 24.8817 16.753 25.0016 16.8714 25.1214C17.1622 25.4161 17.4521 25.7118 17.7414 26.0079C17.9038 26.174 18.0666 26.3396 18.2299 26.5047C18.3831 26.6597 18.5357 26.8154 18.6873 26.9719C19.625 27.9172 20.6194 28.5125 21.9678 28.5527C23.7745 28.5304 24.8428 27.4238 26.0451 26.2133C26.1145 26.1438 26.1838 26.0743 26.2553 26.0027C26.4735 25.7841 26.6913 25.5651 26.9092 25.3462C27.0584 25.1965 27.2077 25.0468 27.357 24.8972C27.72 24.5333 28.0828 24.1691 28.4453 23.8047C28.7821 23.9414 29.009 24.1727 29.2603 24.4265C29.3068 24.4729 29.3534 24.5192 29.4013 24.5669C29.5572 24.7223 29.7125 24.8784 29.8678 25.0344C29.9794 25.1459 30.0911 25.2574 30.2028 25.3689C30.5063 25.672 30.8092 25.9756 31.1121 26.2793C31.4293 26.5973 31.7471 26.9149 32.0647 27.2325C32.5985 27.7664 33.132 28.3006 33.6652 28.8351C34.2808 29.452 34.8968 30.0684 35.5131 30.6846C36.1699 31.3414 36.8264 31.9985 37.4827 32.6556C37.6714 32.8445 37.8602 33.0333 38.0489 33.2221C38.3464 33.5197 38.6437 33.8175 38.9409 34.1155C39.0496 34.2245 39.1584 34.3334 39.2673 34.4422C40.2647 35.4394 40.2647 35.4394 40.7019 35.9567C40.9369 36.2286 41.1995 36.4732 41.459 36.7215C41.5643 36.8243 41.6654 36.9314 41.7656 37.0391C41.7656 37.0958 41.7656 37.1525 41.7656 37.2109C40.9863 37.532 40.1994 37.5049 39.3732 37.5015C39.2171 37.5018 39.061 37.5022 38.9049 37.5027C38.4774 37.5038 38.0498 37.5033 37.6223 37.5025C37.1607 37.5019 36.6991 37.5028 36.2375 37.5035C35.3337 37.5046 34.43 37.5044 33.5262 37.5036C32.7917 37.503 32.0571 37.503 31.3225 37.5032C31.218 37.5033 31.1134 37.5033 31.0056 37.5034C30.7932 37.5035 30.5807 37.5035 30.3683 37.5036C28.3765 37.5044 26.3847 37.5035 24.3929 37.5021C22.6841 37.501 20.9754 37.5012 19.2666 37.5024C17.2819 37.5037 15.2972 37.5043 13.3125 37.5035C13.1008 37.5034 12.8891 37.5033 12.6775 37.5032C12.5733 37.5032 12.4692 37.5032 12.3619 37.5031C11.6283 37.5029 10.8947 37.5033 10.1611 37.5039C9.26695 37.5046 8.37284 37.5044 7.47873 37.503C7.02261 37.5024 6.5665 37.5021 6.11038 37.503C5.69267 37.5037 5.27498 37.5033 4.85727 37.5019C4.70634 37.5016 4.55541 37.5018 4.40448 37.5024C3.64971 37.5053 2.945 37.5037 2.23438 37.2109C2.35379 36.9624 2.46644 36.7869 2.66507 36.5946C2.71608 36.5445 2.7671 36.4945 2.81966 36.4429C2.87289 36.3915 2.92611 36.3401 2.98096 36.2871C3.2865 35.9904 3.58681 35.6952 3.86153 35.3694C4.31704 34.8461 4.81373 34.3625 5.30477 33.873C5.41495 33.7628 5.5251 33.6527 5.63524 33.5425C5.93259 33.2451 6.2302 32.948 6.52786 32.6509C6.83952 32.3398 7.15094 32.0284 7.46238 31.7171C8.05142 31.1283 8.64068 30.5398 9.23002 29.9513C9.90127 29.281 10.5723 28.6105 11.2433 27.9399C12.6228 26.5612 14.0027 25.1829 15.3828 23.8047Z"
                        fill="white"
                      />
                      <path
                        d="M0.343299 8.67969C0.702917 8.84485 0.948773 9.08985 1.22429 9.36813C1.27792 9.42162 1.33156 9.47511 1.38682 9.53022C1.56668 9.7098 1.74592 9.88998 1.92517 10.0702C2.05388 10.1989 2.18262 10.3276 2.3114 10.4563C2.66119 10.8061 3.01044 11.1563 3.3596 11.5067C3.72448 11.8726 4.08985 12.2381 4.45516 12.6036C5.14699 13.296 5.83838 13.9888 6.52962 14.6818C7.31653 15.4706 8.10393 16.2589 8.89137 17.0472C10.5113 18.669 12.1306 20.2913 13.7495 21.9141C13.6076 22.2796 13.3349 22.5244 13.0623 22.7951C13.0089 22.8487 12.9555 22.9023 12.9005 22.9576C12.7214 23.1374 12.5416 23.3167 12.3618 23.4959C12.2333 23.6246 12.1049 23.7534 11.9765 23.8822C11.6275 24.232 11.2779 24.5812 10.9282 24.9304C10.5628 25.2953 10.1979 25.6606 9.83289 26.0259C9.21998 26.6391 8.60672 27.252 7.99325 27.8646C7.28304 28.5739 6.57346 29.2838 5.8642 29.994C5.25598 30.603 4.64743 31.2117 4.0386 31.8201C3.67463 32.1838 3.31077 32.5476 2.94722 32.9117C2.60564 33.2538 2.26366 33.5954 1.92134 33.9367C1.79543 34.0624 1.66967 34.1882 1.54407 34.3142C1.3733 34.4855 1.20202 34.6562 1.03059 34.8267C0.980382 34.8773 0.930174 34.9279 0.878445 34.98C0.534794 35.3203 0.534794 35.3203 0.343299 35.3203C0.0491364 34.6415 -0.0501792 34.0644 -0.0441013 33.3281C-0.0446376 33.2269 -0.0451738 33.1257 -0.0457263 33.0214C-0.0468527 32.7431 -0.0464575 32.4649 -0.0453873 32.1867C-0.044605 31.8856 -0.0458123 31.5845 -0.0467554 31.2834C-0.0482794 30.6946 -0.0479558 30.1058 -0.0469573 29.517C-0.0461792 29.0382 -0.0460765 28.5594 -0.0464499 28.0806C-0.0465025 28.0123 -0.0465552 27.944 -0.0466095 27.8737C-0.0467194 27.7349 -0.0468309 27.5962 -0.0469438 27.4574C-0.0479227 26.1581 -0.0467991 24.8587 -0.0449499 23.5593C-0.0434143 22.4458 -0.0436811 21.3323 -0.0452658 20.2187C-0.0471077 18.9238 -0.0478283 17.629 -0.046774 16.3341C-0.0466646 16.1958 -0.0465565 16.0576 -0.0464499 15.9194C-0.0463968 15.8514 -0.0463438 15.7834 -0.0462892 15.7133C-0.0459931 15.2354 -0.0464918 14.7575 -0.0473022 14.2797C-0.0482689 13.6968 -0.048 13.114 -0.0461745 12.5311C-0.0452745 12.2341 -0.0449113 11.9371 -0.0460539 11.64C-0.0469963 11.3173 -0.0458112 10.9946 -0.0441013 10.6719C-0.0448681 10.579 -0.0456349 10.4861 -0.046425 10.3904C-0.0399832 9.76151 0.0935036 9.25612 0.343299 8.67969Z"
                        fill="white"
                      />
                      <path
                        d="M43.6562 8.67969C43.9504 9.3585 44.0497 9.93556 44.0437 10.6719C44.0442 10.7731 44.0447 10.8743 44.0453 10.9786C44.0464 11.2569 44.046 11.5351 44.0449 11.8133C44.0442 12.1144 44.0454 12.4155 44.0463 12.7166C44.0478 13.3054 44.0475 13.8942 44.0465 14.483C44.0457 14.9618 44.0456 15.4406 44.046 15.9194C44.0461 15.9877 44.0461 16.056 44.0462 16.1263C44.0463 16.2651 44.0464 16.4038 44.0465 16.5426C44.0475 17.8419 44.0463 19.1413 44.0445 20.4407C44.043 21.5542 44.0432 22.6677 44.0448 23.7813C44.0467 25.0762 44.0474 26.371 44.0463 27.6659C44.0462 27.8042 44.0461 27.9424 44.046 28.0806C44.0459 28.1826 44.0459 28.1826 44.0458 28.2867C44.0455 28.7646 44.046 29.2425 44.0469 29.7203C44.0478 30.3032 44.0475 30.886 44.0457 31.4689C44.0448 31.7659 44.0445 32.0629 44.0456 32.36C44.0465 32.6827 44.0454 33.0054 44.0437 33.3281C44.0444 33.421 44.0452 33.5139 44.046 33.6096C44.0395 34.2385 43.906 34.7439 43.6562 35.3203C43.2966 35.1552 43.0508 34.9102 42.7753 34.6319C42.7216 34.5784 42.668 34.5249 42.6127 34.4698C42.4329 34.2902 42.2536 34.11 42.0744 33.9298C41.9457 33.8011 41.8169 33.6724 41.6881 33.5437C41.3384 33.1939 40.9891 32.8437 40.6399 32.4933C40.2751 32.1274 39.9097 31.7619 39.5444 31.3964C38.8526 30.704 38.1612 30.0112 37.4699 29.3182C36.683 28.5294 35.8956 27.7411 35.1082 26.9528C33.4882 25.331 31.8689 23.7087 30.25 22.0859C30.4567 21.6977 30.7215 21.4184 31.0303 21.1119C31.0834 21.0586 31.1365 21.0052 31.1912 20.9502C31.3689 20.7718 31.5472 20.5941 31.7256 20.4163C31.8532 20.2884 31.9808 20.1605 32.1084 20.0325C32.4547 19.6854 32.8016 19.3388 33.1486 18.9923C33.5114 18.63 33.8737 18.2673 34.236 17.9047C34.8444 17.296 35.4531 16.6877 36.062 16.0796C36.7669 15.3757 37.4712 14.6711 38.1751 13.9662C38.7789 13.3616 39.3831 12.7573 39.9876 12.1533C40.3488 11.7923 40.71 11.4312 41.0709 11.0698C41.4098 10.7303 41.7492 10.3913 42.0889 10.0526C42.2139 9.92784 42.3387 9.80298 42.4633 9.67797C42.6327 9.50806 42.8027 9.33868 42.9728 9.16944C43.0226 9.11924 43.0724 9.06904 43.1238 9.01732C43.4648 8.67969 43.4648 8.67969 43.6562 8.67969Z"
                        fill="white"
                      />
                    </g>
                    <defs>
                      <clipPath id="clip0_623_80">
                        <rect width="44" height="44" fill="white" />
                      </clipPath>
                    </defs>
                  </svg>
                </span>
                <span>
                  <input
                    type="email"
                    placeholder="your email address"
                    value={email} // Mengikat nilai input dengan state
                    onChange={handleChange} // Memperbarui state saat input berubah
                    required
                  />
                </span>
              </div>
              <button onClick={handleSubscribe}>subscribed</button>
            </div>
            <img src="img/email.png" alt="" />
          </div>
        
        <ToastContainer />
      </div>
    ) : null}
    </div>
  );
};

export default Subscripe;
